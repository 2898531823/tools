#!/bin/bash
# ä¸€ä¸ªå¥å£®çš„è„šæœ¬ï¼Œç”¨äºç®¡ç†åª’ä½“å‘å¸ƒå·¥å…·é“¾ï¼ˆjietu, bdinfo, mkbrrç­‰ï¼‰åŠå…¶ä¾èµ–ç¯å¢ƒã€‚
# v31 - ä¼˜åŒ–Pythonç¯å¢ƒå¤„ç†é€»è¾‘ï¼Œå°†python3å’Œpipè§†ä¸ºä¸€ä¸ªæ•´ä½“è¿›è¡Œæ£€æµ‹å’Œå®‰è£…ã€‚

# å¦‚æœå‘½ä»¤å¤±è´¥ï¼Œç«‹å³é€€å‡ºã€‚
# ç®¡é“ä¸­ä»»ä½•ä¸€ä¸ªå‘½ä»¤å¤±è´¥ï¼Œæ•´ä¸ªç®¡é“éƒ½ç®—å¤±è´¥ã€‚
set -o pipefail

# --- ç»Ÿä¸€é…ç½® ---
LOG_FILE="/var/log/media_manager.log"
DEBUG_LOG_FILE="/var/log/media_manager.debug.log"
VERSION_DIR="/usr/local/etc/media_tool_versions"
BDINFOCLI_INSTALL_DIR="/etc/abox/app/bdinfocli"
BDINFOCLI_POSSIBLE_PATHS=("/etc/abox/app/bdinfocli" "/opt/bdinfocli")

# --- é¢œè‰²ä¸ç¬¦å·å®šä¹‰ ---
readonly bold="\033[1m"; readonly blue="\033[34m"; readonly red="\033[31m"; readonly green="\033[32m"
readonly yellow="\033[33m"; readonly dim="\033[2m"; readonly normal="\033[0m"
readonly I_INFO="i"; readonly I_OK="âœ“"; readonly I_WARN="!"; readonly I_ERR="âœ—"; readonly I_STEP="â†’"

# --- å…¨å±€å˜é‡ ---
OS=""; OS_ID=""; PIP_COMMAND=""

# --- æ¶ˆæ¯ä¸æ—¥å¿—å‡½æ•° ---
log() { run_as_user tee -a "$LOG_FILE" >/dev/null <<< "[$1] $(date '+%Y-%m-%d %H:%M:%S') - $2"; }
print_header() { local msg="$1"; echo -e "\n${bold}${blue}--- ${msg} ---${normal}"; }
msg_step() { echo -e "  ${dim}${I_STEP}${normal} $1"; log "STEP" "$1"; }
msg_info() { echo -e "  ${blue}${I_INFO}${normal} $1"; log "INFO" "$1"; }
msg_ok()   { echo -e "  ${green}${I_OK}${normal} $1"; log "OK" "$1"; }
msg_err()  { echo -e "  ${red}${I_ERR}${normal} $1"; log "ERROR" "$1"; }
msg_warn() { echo -e "  ${yellow}${I_WARN}${normal} $1"; log "WARN" "$1"; }
spinner() {
    local pid=$1; local delay=0.1; local spinstr='|/-\'
    while ps -p "$pid" > /dev/null; do
        local temp=${spinstr#?}; printf " [%c]  " "$spinstr"; local spinstr=$temp${spinstr%"$temp"}; sleep $delay; printf "\b\b\b\b\b\b"
    done; printf "      \b\b\b\b\b\b"
}

# --- æ ¸å¿ƒå‡½æ•° ---
run_as_user() { if [[ $EUID -eq 0 ]]; then "$@"; else sudo "$@"; fi; }
run_cmd() {
    local cmd_str="$*"; msg_step "æ‰§è¡Œå‘½ä»¤: ${dim}${cmd_str}${normal}"; local output_file; output_file=$(mktemp)
    (run_as_user "$@" >> "$output_file" 2>&1) & local cmd_pid=$!; spinner $cmd_pid; wait $cmd_pid; local exit_code=$?
    run_as_user tee -a "$DEBUG_LOG_FILE" < "$output_file" >/dev/null
    if [ $exit_code -eq 0 ]; then
        msg_ok "å‘½ä»¤æˆåŠŸæ‰§è¡Œã€‚"; rm -f "$output_file"; return 0
    else
        msg_err "å‘½ä»¤æ‰§è¡Œå¤±è´¥ (é€€å‡ºç : $exit_code)ã€‚è¯¦æƒ…è¯·æŸ¥çœ‹è°ƒè¯•æ—¥å¿—: $DEBUG_LOG_FILE"
        echo -e "${dim}--- é”™è¯¯è¾“å‡º ---\n$(cat "$output_file")\n--- ç»“æŸ ---${normal}" >&2; rm -f "$output_file"; return "$exit_code"
    fi
}
# --- å¸®åŠ©å‡½æ•° ---
show_help() {
    echo -e "${bold}åª’ä½“å‘å¸ƒå·¥å…·é“¾ç®¡ç†å™¨ (v31)${normal}"; echo -e "ä¸€ä¸ªç”¨äºå®‰è£…ã€æ›´æ–°å’Œç®¡ç†åª’ä½“å‘å¸ƒå·¥å…· (jietu, bdinfo, mkbrr) åŠå…¶ä¾èµ–çš„è„šæœ¬ã€‚"
    echo -e "ç‰¹æ€§: è‡ªåŠ¨å®‰è£…æ‰€æœ‰ä¾èµ–, æ™ºèƒ½ç‰ˆæœ¬ç®¡ç†, ä¸“ä¸šçº§UIå’Œæ—¥å¿—ç³»ç»Ÿã€‚"; echo
    echo -e "${bold}${blue}ç”¨æ³•:${normal}"; echo -e "  $0 [ç®¡ç†å‘½ä»¤]"; echo -e "  $0 [å·¥å…·å] [å·¥å…·å‚æ•°...]"; echo -e "  $0                  (è¿›å…¥äº¤äº’å¼ç¯å¢ƒç®¡ç†èœå•)"; echo
    echo -e "${bold}${blue}ç®¡ç†å‘½ä»¤:${normal}"
    echo -e "  ${yellow}--install${normal}                 å®‰è£…æˆ–ä¿®å¤æ‰€æœ‰å·¥å…·åŠå…¶ä¾èµ–ã€‚"
    echo -e "  ${yellow}--check${normal}                   æ£€æµ‹æ‰€æœ‰å·¥å…·å’Œä¾èµ–çš„çŠ¶æ€ã€‚"
    echo -e "  ${yellow}--update${normal}                  æ£€æŸ¥å¹¶æ›´æ–°æ‰€æœ‰å¯æ›´æ–°çš„ç»„ä»¶ã€‚"
    echo -e "  ${yellow}--uninstall${normal}               å¸è½½æ‰€æœ‰å·¥å…·å’Œä¾èµ–ã€‚"
    echo -e "  ${yellow}--help, -h${normal}                  æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯å¹¶é€€å‡ºã€‚"
}
# --- ç¯å¢ƒç®¡ç†ä¸æ£€æµ‹ ---
detect_os() { if [[ -n "$OS_ID" ]]; then return 0; fi; if [[ -f /etc/os-release ]]; then . /etc/os-release; OS=$NAME; OS_ID=$ID; elif type lsb_release >/dev/null 2>&1; then OS=$(lsb_release -si); OS_ID=$(lsb_release -si | tr '[:upper:]' '[:lower:]'); else msg_err "æ— æ³•æ£€æµ‹æ“ä½œç³»ç»Ÿã€‚"; return 1; fi; }
detect_pip_command() { PIP_COMMAND=""; if command -v pip3 &>/dev/null; then PIP_COMMAND="pip3"; elif command -v pip &>/dev/null; then if pip --version 2>/dev/null | grep -q 'python 3'; then PIP_COMMAND="pip"; fi; fi; }
ensure_command() {
    local cmd_name="$1"; local pkg_name="${2:-$cmd_name}"; local arch_pkg_name="${3:-$pkg_name}"; local target_pkg_name=$pkg_name; [[ "$OS_ID" == "arch" ]] && target_pkg_name=$arch_pkg_name
    if command -v "$cmd_name" &>/dev/null; then msg_ok "å‘½ä»¤ '$cmd_name' å·²å­˜åœ¨ã€‚"; return 0; fi; msg_warn "å‘½ä»¤ '$cmd_name' æœªæ‰¾åˆ°ï¼Œå°è¯•å®‰è£…è½¯ä»¶åŒ… '$target_pkg_name'..."
    case "$OS_ID" in debian|ubuntu) run_cmd apt-get install -y "$pkg_name";; centos|fedora|rhel) if command -v dnf &>/dev/null; then run_cmd dnf install -y "$pkg_name"; else run_cmd yum install -y "$pkg_name"; fi;; arch) run_cmd pacman -S --noconfirm "$target_pkg_name";; *) msg_err "æ— æ³•ä¸ºæœªçŸ¥ç³»ç»Ÿ '$OS_ID' è‡ªåŠ¨å®‰è£… '$target_pkg_name'ã€‚"; return 1;; esac
    if ! command -v "$cmd_name" &>/dev/null; then msg_err "å®‰è£… '$target_pkg_name' åï¼Œå‘½ä»¤ '$cmd_name' ä»ç„¶ä¸å¯ç”¨ã€‚"; return 1; fi
}
get_status_line() { local name="$1"; local status="$2"; printf "  %-22s: %b\n" "$name" "$status"; }

ensure_python_env() {
    print_header "æ£€æŸ¥å¹¶å®‰è£… Python ç¯å¢ƒ"
    detect_pip_command
    if command -v python3 &>/dev/null && [[ -n "$PIP_COMMAND" ]]; then
        msg_ok "Python 3 å’Œ Pip ç¯å¢ƒå·²å®Œæ•´ã€‚"
        return 0
    fi

    msg_warn "Python ç¯å¢ƒä¸å®Œæ•´ï¼Œæ­£åœ¨å°è¯•å®‰è£…/ä¿®å¤..."
    local python_pkg="python3"
    local pip_pkg="python3-pip"
    if [[ "$OS_ID" == "arch" ]]; then
        python_pkg="python"
        pip_pkg="python-pip"
    fi

    # ä¸€æ¬¡æ€§å®‰è£…pythonå’Œpipï¼Œè®©åŒ…ç®¡ç†å™¨å¤„ç†ä¾èµ–
    if ! run_cmd apt-get install -y "$python_pkg" "$pip_pkg" 2>/dev/null || ! run_cmd dnf install -y "$python_pkg" "$pip_pkg" 2>/dev/null || ! run_cmd pacman -S --noconfirm "$python_pkg" "$pip_pkg" 2>/dev/null; then
        # å…¼å®¹æ—§ç³»ç»Ÿæˆ–åˆ†ç¦»åŒ…çš„æƒ…å†µ
        ensure_command "python3" "$python_pkg"
        ensure_command "pip3" "$pip_pkg"
    fi

    detect_pip_command
    if ! command -v python3 &>/dev/null || [[ -z "$PIP_COMMAND" ]]; then
        msg_err "Python ç¯å¢ƒå®‰è£…å¤±è´¥ã€‚"
        return 1
    fi
    msg_ok "Python ç¯å¢ƒå®‰è£…æˆåŠŸã€‚"
}

install_tool_script() {
    local tool_name="$1"; local repo_owner="2898531823"; local repo_name="seedbox-info"; local branch="master"; local script_path="script"
    print_header "å®‰è£…/æ›´æ–° $tool_name å·¥å…·"; if ! ensure_command "wget"; then return 1; fi
    local url="https://raw.githubusercontent.com/${repo_owner}/${repo_name}/${branch}/${script_path}/${tool_name}"; local dest="/usr/local/bin/${tool_name}"
    msg_step "ä»æ‚¨çš„ä»“åº“ä¸‹è½½: $url"; if ! run_cmd wget -q "$url" -O "$dest"; then msg_err "$tool_name ä¸‹è½½å¤±è´¥ã€‚"; return 1; fi
    msg_step "æˆäºˆæ‰§è¡Œæƒé™..."; run_cmd chmod +x "$dest"; msg_ok "$tool_name å·²å®‰è£…åˆ° $dest"
}
install_mkbrr() {
    print_header "å®‰è£…/æ›´æ–° mkbrr"; if ! ensure_command "wget" || ! ensure_command "tar" || ! ensure_command "curl" || ! ensure_command "jq"; then msg_err "å®‰è£… mkbrr éœ€è¦ wget, tar, curl å’Œ jq å‘½ä»¤ã€‚"; return 1; fi
    msg_step "ä» GitHub API è·å–æœ€æ–°ç‰ˆæœ¬ä¿¡æ¯..."; local api_url="https://api.github.com/repos/autobrr/mkbrr/releases/latest"; local api_response; api_response=$(curl -s "$api_url")
    if [[ -z "$api_response" ]]; then msg_err "æ— æ³•è¿æ¥åˆ° GitHub APIã€‚"; return 1; fi
    local latest_version; latest_version=$(echo "$api_response" | jq -r '.tag_name'); local download_url; download_url=$(echo "$api_response" | jq -r '.assets[] | select(.name | contains("linux_x86_64.tar.gz")) | .browser_download_url')
    if [[ -z "$latest_version" || "$latest_version" == "null" || -z "$download_url" || "$download_url" == "null" ]]; then msg_err "æ— æ³•ä» GitHub API è§£ææœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½é“¾æ¥ã€‚"; return 1; fi
    msg_ok "æœ€æ–°ç‰ˆæœ¬ä¸º: ${yellow}$latest_version${normal}"; local temp_dir; temp_dir=$(mktemp -d); trap 'rm -rf "$temp_dir"' RETURN
    msg_step "ä¸‹è½½ mkbrr ($latest_version)..."; if ! wget -qO "$temp_dir/mkbrr.tar.gz" "$download_url"; then msg_err "ä¸‹è½½ mkbrr å¤±è´¥ã€‚"; return 1; fi
    msg_step "è§£å‹æ–‡ä»¶..."; if ! tar -xzf "$temp_dir/mkbrr.tar.gz" -C "$temp_dir"; then msg_err "è§£å‹ mkbrr å¤±è´¥ã€‚"; return 1; fi
    msg_step "ç§»åŠ¨åˆ° /usr/local/bin/ å¹¶è®¾ç½®æƒé™..."; if ! run_cmd mv "$temp_dir/mkbrr" /usr/local/bin/mkbrr; then return 1; fi; run_cmd chmod +x /usr/local/bin/mkbrr
    run_as_user mkdir -p "$VERSION_DIR"; echo "$latest_version" | run_as_user tee "$VERSION_DIR/mkbrr.version" > /dev/null; msg_ok "mkbrr å®‰è£…/æ›´æ–°å®Œæˆã€‚"
}
install_nconvert() {
    print_header "å®‰è£… nconvert"; if command -v nconvert &>/dev/null; then msg_ok "nconvert å·²å®‰è£…ã€‚"; return 0; fi
    if ! ensure_command "wget" || ! ensure_command "tar"; then msg_err "å®‰è£… nconvert éœ€è¦ wget å’Œ tar å‘½ä»¤ã€‚"; return 1; fi
    local temp_dir; temp_dir=$(mktemp -d); trap 'rm -rf "$temp_dir"' RETURN
    msg_step "ä¸‹è½½ NConvert..."; if ! wget -qO "$temp_dir/NConvert-linux64.tgz" https://download.xnview.com/NConvert-linux64.tgz; then msg_err "ä¸‹è½½ nconvert å¤±è´¥ã€‚"; return 1; fi
    msg_step "è§£å‹æ–‡ä»¶..."; if ! tar -xzf "$temp_dir/NConvert-linux64.tgz" --strip-components=1 -C "$temp_dir"; then msg_err "è§£å‹ nconvert å¤±è´¥ã€‚"; return 1; fi
    msg_step "ç§»åŠ¨åˆ° /usr/local/bin/ å¹¶è®¾ç½®æƒé™..."; if ! run_cmd mv "$temp_dir/nconvert" /usr/local/bin/nconvert; then return 1; fi; run_cmd chmod +x /usr/local/bin/nconvert
    run_as_user mkdir -p "$VERSION_DIR"; echo "n/a" | run_as_user tee "$VERSION_DIR/nconvert.version" > /dev/null
}
install_all_dependencies() {
    print_header "å®‰è£…æ‰€æœ‰ä¾èµ–ç¯å¢ƒ"; detect_os
    ensure_command "curl"; ensure_command "jq"; ensure_command "wget"; ensure_command "tar"; ensure_command "mediainfo"; ensure_command "ffmpeg"; ensure_command "bc" "bc"; ensure_command "numfmt" "coreutils"; ensure_command "mono" "mono-complete"; ensure_command "git"
    ensure_python_env
    if [[ -n "$PIP_COMMAND" ]]; then msg_step "å®‰è£…/æ›´æ–° Python åŒ…..."; run_cmd "$PIP_COMMAND" install -U imgbox-cli ptpimg-uploader --break-system-packages; fi
}
install_all_tools() {
    print_header "å®‰è£…æ‰€æœ‰å·¥å…·è„šæœ¬"; install_tool_script "jietu"; install_tool_script "bdinfo"; install_mkbrr; install_nconvert
}
install_all_environments() {
    print_header "ä¸€é”®å®‰è£…/ä¿®å¤æ‰€æœ‰ç¯å¢ƒä¸å·¥å…·"; install_all_dependencies; install_all_tools; msg_ok "æ‰€æœ‰ç¯å¢ƒå’Œå·¥å…·çš„å®‰è£…/ä¿®å¤æµç¨‹å·²å®Œæˆã€‚"
}
check_environment_status() {
    print_header "ç¯å¢ƒçŠ¶æ€æ£€æµ‹"; detect_os; detect_pip_command; local all_ok=1
    echo -e "${bold}  ğŸ› ï¸ å·¥å…·è„šæœ¬:${normal}"
    command -v jietu &>/dev/null && get_status_line "jietu" "${green}${I_OK} å·²å®‰è£…${normal}" || { get_status_line "jietu" "${red}${I_ERR} æœªå®‰è£…${normal}"; all_ok=0; }
    command -v bdinfo &>/dev/null && get_status_line "bdinfo" "${green}${I_OK} å·²å®‰è£…${normal}" || { get_status_line "bdinfo" "${red}${I_ERR} æœªå®‰è£…${normal}"; all_ok=0; }
    if command -v mkbrr &>/dev/null; then local ver_info=""; if [[ -f "$VERSION_DIR/mkbrr.version" ]]; then ver_info=" ($(run_as_user cat "$VERSION_DIR/mkbrr.version"))"; fi; get_status_line "mkbrr" "${green}${I_OK} å·²å®‰è£…${ver_info}${normal}"; else get_status_line "mkbrr" "${red}${I_ERR} æœªå®‰è£…${normal}"; all_ok=0; fi
    command -v nconvert &>/dev/null && get_status_line "nconvert" "${green}${I_OK} å·²å®‰è£…${normal}" || { get_status_line "nconvert" "${red}${I_ERR} æœªå®‰è£…${normal}"; all_ok=0; }

    echo -e "\n${bold}  âš™ï¸ ä¾èµ–ç¯å¢ƒ:${normal}"
    if command -v python3 &>/dev/null && [[ -n "$PIP_COMMAND" ]]; then get_status_line "Python Env" "${green}${I_OK} å·²å®Œæ•´ ($(python3 -V 2>&1), $PIP_COMMAND)${normal}"; else
        local py_status; py_status=$(command -v python3 &>/dev/null && echo "æœ‰python3" || echo "æ— python3")
        local pip_status; pip_status=$([[ -n "$PIP_COMMAND" ]] && echo "æœ‰pip" || echo "æ— pip")
        get_status_line "Python Env" "${red}${I_ERR} æœªå®Œæ•´ ($py_status, $pip_status)${normal}"; all_ok=0
    fi
    # ... å…¶ä»–ä¾èµ–æ£€æµ‹
    command -v mediainfo &>/dev/null && get_status_line "mediainfo" "${green}${I_OK} å·²å®‰è£…${normal}" || { get_status_line "mediainfo" "${red}${I_ERR} æœªå®‰è£…${normal}"; all_ok=0; }

    echo; if [[ $all_ok -eq 1 ]]; then msg_ok "æ‰€æœ‰å·¥å…·å’Œä¾èµ–å‡å·²æ­£ç¡®å®‰è£…ã€‚"; else msg_warn "ç¯å¢ƒä¸å®Œæ•´ï¼è¯·è¿›å…¥èœå•é€‰æ‹© 'å®‰è£…/ä¿®å¤ç¯å¢ƒ'ã€‚"; fi
}
uninstall_all() {
    print_header "ç¯å¢ƒä¸å·¥å…·å¸è½½"; detect_os; detect_pip_command
    msg_step "å¸è½½å·¥å…·è„šæœ¬..."; run_cmd rm -f /usr/local/bin/jietu /usr/local/bin/bdinfo /usr/local/bin/mkbrr /usr/local/bin/nconvert
    msg_step "å¸è½½PythonåŒ…..."; if [[ -n "$PIP_COMMAND" ]]; then run_cmd "$PIP_COMMAND" uninstall -y imgbox-cli ptpimg-uploader; fi
    msg_step "å¸è½½ç³»ç»Ÿä¾èµ–åŒ…..."; case "$OS_ID" in
        debian|ubuntu) run_cmd apt purge -y curl jq mediainfo ffmpeg mono-complete python3 python3-pip git bc coreutils; run_cmd apt autoremove -y;;
        #...
    esac
    msg_step "æ¸…ç†ç‰ˆæœ¬å’Œé…ç½®ç›®å½•..."; run_cmd rm -rf "$VERSION_DIR" "$BDINFOCLI_INSTALL_DIR"
    msg_ok "å¸è½½å®Œæˆã€‚"
}
# --- ä¸»ç¨‹åº ---
main() {
    # å‘½ä»¤è¡Œç›´æ¥è°ƒç”¨æ¨¡å¼
    if [[ $# -gt 0 ]]; then
        case "$1" in
            --install) install_all_environments; exit $?;;
            --check) check_environment_status; exit $?;;
            --update) msg_err "æ­¤å‘½ä»¤å·²å¼ƒç”¨ï¼Œè¯·ä½¿ç”¨ --install æ›´æ–°æ‰€æœ‰å·¥å…·è‡³æœ€æ–°ç‰ˆã€‚"; exit 1;;
            --uninstall) uninstall_all; exit $?;;
            --help|-h) show_help; exit 0;;
            *)
                if command -v "$1" &>/dev/null; then
                    msg_info "æ£€æµ‹åˆ°å·¥å…·å‘½ä»¤ '$1'ï¼Œå°†ç›´æ¥è°ƒç”¨å®ƒ..."
                    local tool_to_run="$1"; shift
                    "$tool_to_run" "$@"
                    exit $?
                else
                    msg_err "æœªçŸ¥ç®¡ç†å™¨å‘½ä»¤æˆ–ç³»ç»Ÿå‘½ä»¤: '$1'"; show_help; exit 1
                fi
                ;;
        esac
    fi

    # äº¤äº’èœå•æ¨¡å¼
    run_as_user touch "$LOG_FILE" &>/dev/null; run_as_user touch "$DEBUG_LOG_FILE" &>/dev/null

    while true; do
        clear; print_header "åª’ä½“å·¥å…·é“¾ç®¡ç†å™¨ (äº¤äº’æ¨¡å¼)"
        echo " 1. æ£€æµ‹ç¯å¢ƒä¸å·¥å…·"
        echo " 2. å®‰è£…/ä¿®å¤æ‰€æœ‰ç¯å¢ƒä¸å·¥å…·"
        echo " 3. å¸è½½æ‰€æœ‰ç¯å¢ƒä¸å·¥å…·"
        echo " 0. é€€å‡ºè„šæœ¬"
        echo -e "----------------------------------------"
        echo -e "${dim}æç¤º: ä½¿ç”¨ --help æŸ¥çœ‹æ‰€æœ‰å‘½ä»¤è¡ŒåŠŸèƒ½ã€‚${normal}"
        read -p "è¯·è¾“å…¥é€‰é¡¹ (0-3): " CHOICE
        case "$CHOICE" in
            1) check_environment_status; read -p "æŒ‰ä»»æ„é”®ç»§ç»­...";;
            2) install_all_environments; read -p "æŒ‰ä»»æ„é”®ç»§ç»­...";;
            3) read -p "âš ï¸ ç¡®è®¤å¸è½½æ‰€æœ‰ç›¸å…³ç¯å¢ƒå’Œå·¥å…·? (y/n): " CONFIRM; if [[ "$CONFIRM" =~ ^[yY]$ ]]; then uninstall_all; else msg_info "æ“ä½œå·²å–æ¶ˆã€‚"; fi; read -p "æŒ‰ä»»æ„é”®ç»§ç»­...";;
            0) echo "ğŸ‘‹ æ­£åœ¨é€€å‡ºç¨‹åºã€‚"; exit 0;;
            *) msg_err "æ— æ•ˆé€‰é¡¹"; sleep 1;;
        esac
    done
}

main "$@"